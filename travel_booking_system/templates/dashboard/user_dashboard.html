{% extends 'base.html' %}
{% load static %}

{% block title %}My Dashboard - Travel Booking System{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Welcome Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-lg">
                <div class="card-body p-4 p-md-5">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="display-4 fw-bold text-primary mb-3">Welcome back, {{ request.user.first_name|default:request.user.username }}!</h1>
                            <p class="lead text-muted mb-4">Manage your travel bookings and preferences from one place.</p>
                            <div class="d-flex gap-3">
                                <a href="{% url 'bookings:my_bookings' %}" class="btn btn-primary btn-lg px-4">
                                    <i class="fas fa-calendar-check me-2"></i>My Bookings
                                </a>
                                <a href="{% url 'payments:my_payments' %}" class="btn btn-outline-primary btn-lg px-4">
                                    <i class="fas fa-receipt me-2"></i>Payment History
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4 text-center d-none d-md-block">
                            <i class="fas fa-globe-americas text-primary" style="font-size: 8rem; opacity: 0.1;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-5">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start-primary border-bottom-primary border-3 border-0 shadow h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                                Total Bookings
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ stats.total_bookings }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-check fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start-success border-bottom-success border-3 border-0 shadow h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">
                                Upcoming Trips
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ stats.upcoming_bookings }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-plane-departure fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start-warning border-bottom-warning border-3 border-0 shadow h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                                Total Spent
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">${{ stats.total_spent|floatformat:2 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start-info border-bottom-info border-3 border-0 shadow h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">
                                Wallet Balance
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">${{ stats.wallet_balance|floatformat:2 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-wallet fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Bookings & Quick Actions -->
    <div class="row">
        <!-- Recent Bookings -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Bookings</h5>
                        <a href="{% url 'bookings:my_bookings' %}" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                </div>
                <div class="card-body">
                    {% if recent_bookings %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Booking Ref</th>
                                        <th>Service</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for booking in recent_bookings %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'bookings:booking_detail' pk=booking.id %}" class="fw-bold">
                                                {{ booking.booking_reference }}
                                            </a>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas 
                                                    {% if booking.service_type == 'HOTEL' %}fa-hotel
                                                    {% elif booking.service_type == 'CAR' %}fa-car
                                                    {% elif booking.service_type == 'BUS' %}fa-bus
                                                    {% else %}fa-train{% endif %} 
                                                    me-2 text-primary"></i>
                                                {{ booking.get_service_type_display }}
                                            </div>
                                        </td>
                                        <td>{{ booking.booking_date|date:"M d, Y" }}</td>
                                        <td class="fw-bold">${{ booking.total_amount|floatformat:2 }}</td>
                                        <td>
                                            <span class="badge 
                                                {% if booking.status == 'CONFIRMED' %}bg-success
                                                {% elif booking.status == 'PENDING' %}bg-warning
                                                {% elif booking.status == 'CANCELLED' %}bg-danger
                                                {% else %}bg-secondary{% endif %}">
                                                {{ booking.get_status_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'bookings:booking_detail' pk=booking.id %}" 
                                                   class="btn btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% if booking.status == 'CONFIRMED' %}
                                                <a href="{% url 'bookings:booking_invoice' pk=booking.id %}" 
                                                   class="btn btn-outline-success">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Bookings Yet</h5>
                            <p class="text-muted">Start your travel journey by making your first booking!</p>
                            <a href="{% url 'home' %}" class="btn btn-primary mt-2">
                                <i class="fas fa-search me-2"></i>Explore Services
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions & Profile -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card shadow mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'hotels:hotel_search' %}" class="btn btn-outline-primary text-start">
                            <i class="fas fa-hotel me-2"></i>Book a Hotel
                        </a>
                        <a href="{% url 'cars:car_search' %}" class="btn btn-outline-success text-start">
                            <i class="fas fa-car me-2"></i>Rent a Car
                        </a>
                        <a href="{% url 'buses:bus_search' %}" class="btn btn-outline-danger text-start">
                            <i class="fas fa-bus me-2"></i>Book Bus Tickets
                        </a>
                        <a href="{% url 'trains:train_search' %}" class="btn btn-outline-warning text-start">
                            <i class="fas fa-train me-2"></i>Book Train Tickets
                        </a>
                    </div>
                </div>
            </div>

            <!-- Profile Summary -->
            <div class="card shadow">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0"><i class="fas fa-user-circle me-2"></i>Profile Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            {% if request.user.profile_image %}
                                <img src="{{ request.user.profile_image.url }}" 
                                     alt="{{ request.user.username }}" 
                                     class="rounded-circle" width="60" height="60">
                            {% else %}
                                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                                     style="width: 60px; height: 60px;">
                                    <span class="text-white fw-bold fs-4">{{ request.user.first_name|first|default:request.user.username|first|upper }}</span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">{{ request.user.get_full_name|default:request.user.username }}</h6>
                            <p class="text-muted mb-0">{{ request.user.email }}</p>
                            <small class="text-muted">Member since {{ request.user.date_joined|date:"M Y" }}</small>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h5 mb-0">{{ stats.total_bookings }}</div>
                            <small class="text-muted">Bookings</small>
                        </div>
                        <div class="col-4">
                            <div class="h5 mb-0">{{ stats.completed_trips }}</div>
                            <small class="text-muted">Trips</small>
                        </div>
                        <div class="col-4">
                            <div class="h5 mb-0">{{ stats.loyalty_points }}</div>
                            <small class="text-muted">Points</small>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-grid">
                        <a href="{% url 'profile_update' %}" class="btn btn-outline-primary">
                            <i class="fas fa-edit me-2"></i>Edit Profile
                        </a>
                    </div>
                </div>
            </div>

            <!-- Upcoming Trips -->
            {% if upcoming_bookings %}
            <div class="card shadow mt-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0"><i class="fas fa-plane-departure me-2"></i>Upcoming Trips</h5>
                </div>
                <div class="card-body">
                    {% for booking in upcoming_bookings|slice:":3" %}
                    <div class="mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ booking.get_service_type_display }}</h6>
                                <p class="text-muted mb-1 small">
                                    {% if booking.service_type == 'HOTEL' %}
                                        {{ booking.check_in_date|date:"M d" }} - {{ booking.check_out_date|date:"M d" }}
                                    {% else %}
                                        {{ booking.travel_date|date:"M d, Y" }}
                                    {% endif %}
                                </p>
                            </div>
                            <span class="badge bg-success">Confirmed</span>
                        </div>
                        <a href="{% url 'bookings:booking_detail' pk=booking.id %}" class="btn btn-sm btn-outline-primary mt-2 w-100">
                            View Details
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Loyalty & Offers -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card shadow border-0">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-crown me-2"></i>Your Travel Benefits</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-4">
                            <div class="rounded-circle bg-warning d-inline-flex align-items-center justify-content-center" 
                                 style="width: 80px; height: 80px;">
                                <i class="fas fa-medal fa-2x text-white"></i>
                            </div>
                            <h5 class="mt-3">{{ stats.loyalty_points }} Points</h5>
                            <p class="text-muted">Loyalty Points Earned</p>
                        </div>
                        <div class="col-md-4 text-center mb-4">
                            <div class="rounded-circle bg-success d-inline-flex align-items-center justify-content-center" 
                                 style="width: 80px; height: 80px;">
                                <i class="fas fa-percentage fa-2x text-white"></i>
                            </div>
                            <h5 class="mt-3">5% Cashback</h5>
                            <p class="text-muted">On your next booking</p>
                        </div>
                        <div class="col-md-4 text-center mb-4">
                            <div class="rounded-circle bg-info d-inline-flex align-items-center justify-content-center" 
                                 style="width: 80px; height: 80px;">
                                <i class="fas fa-gift fa-2x text-white"></i>
                            </div>
                            <h5 class="mt-3">Exclusive Offers</h5>
                            <p class="text-muted">Personalized deals for you</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card {
    transition: transform 0.3s;
}
.card:hover {
    transform: translateY(-5px);
}
.border-start-primary { border-left-color: #4e73df !important; }
.border-start-success { border-left-color: #1cc88a !important; }
.border-start-warning { border-left-color: #f6c23e !important; }
.border-start-info { border-left-color: #36b9cc !important; }
</style>
{% endblock %}