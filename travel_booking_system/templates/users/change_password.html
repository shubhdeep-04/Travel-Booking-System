{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Change Password - TravelBook{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow">
            <div class="card-header bg-warning text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-key"></i> Change Password</h4>
                    <a href="{% url 'profile' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-left"></i> Back to Profile
                    </a>
                </div>
            </div>
            <div class="card-body">
                <form method="POST">
                    {% csrf_token %}
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Password must be at least 8 characters long and contain letters and numbers.
                    </div>
                    
                    {{ form.current_password|as_crispy_field }}
                    {{ form.new_password|as_crispy_field }}
                    {{ form.confirm_password|as_crispy_field }}
                    
                    <div class="password-strength mb-3">
                        <small class="text-muted">Password Strength:</small>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" id="password-strength-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <div class="password-requirements">
                        <small class="text-muted d-block mb-2">Password Requirements:</small>
                        <ul class="list-unstyled small">
                            <li id="length-check"><i class="fas fa-times text-danger me-2"></i>At least 8 characters</li>
                            <li id="letter-check"><i class="fas fa-times text-danger me-2"></i>Contains letters</li>
                            <li id="number-check"><i class="fas fa-times text-danger me-2"></i>Contains numbers</li>
                        </ul>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'profile' %}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-warning">Change Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        let lengthOk = false;
        let letterOk = false;
        let numberOk = false;
        
        // Length check
        if (password.length >= 8) {
            strength += 25;
            lengthOk = true;
            document.getElementById('length-check').innerHTML = '<i class="fas fa-check text-success me-2"></i>At least 8 characters';
        } else {
            document.getElementById('length-check').innerHTML = '<i class="fas fa-times text-danger me-2"></i>At least 8 characters';
        }
        
        // Letter check
        if (/[a-zA-Z]/.test(password)) {
            strength += 25;
            letterOk = true;
            document.getElementById('letter-check').innerHTML = '<i class="fas fa-check text-success me-2"></i>Contains letters';
        } else {
            document.getElementById('letter-check').innerHTML = '<i class="fas fa-times text-danger me-2"></i>Contains letters';
        }
        
        // Number check
        if (/[0-9]/.test(password)) {
            strength += 25;
            numberOk = true;
            document.getElementById('number-check').innerHTML = '<i class="fas fa-check text-success me-2"></i>Contains numbers';
        } else {
            document.getElementById('number-check').innerHTML = '<i class="fas fa-times text-danger me-2"></i>Contains numbers';
        }
        
        // Special character check
        if (/[^a-zA-Z0-9]/.test(password)) {
            strength += 25;
        }
        
        // Update progress bar
        const bar = document.getElementById('password-strength-bar');
        bar.style.width = strength + '%';
        
        // Update color based on strength
        if (strength < 50) {
            bar.className = 'progress-bar bg-danger';
        } else if (strength < 75) {
            bar.className = 'progress-bar bg-warning';
        } else {
            bar.className = 'progress-bar bg-success';
        }
        
        return lengthOk && letterOk && numberOk;
    }
    
    // Event listeners
    document.getElementById('id_new_password').addEventListener('input', function(e) {
        checkPasswordStrength(e.target.value);
    });
    
    document.getElementById('id_confirm_password').addEventListener('input', function(e) {
        const newPassword = document.getElementById('id_new_password').value;
        const confirmPassword = e.target.value;
        
        if (confirmPassword && newPassword !== confirmPassword) {
            e.target.setCustomValidity('Passwords do not match');
        } else {
            e.target.setCustomValidity('');
        }
    });
</script>
{% endblock %}