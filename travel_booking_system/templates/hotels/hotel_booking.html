{% extends 'base.html' %}
{% load static %}

{% block title %}Book Hotel - Travel Booking System{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Progress Steps -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="progress-steps">
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-label">Room Selection</div>
                </div>
                <div class="step {% if form.errors %}active{% endif %}">
                    <div class="step-number">2</div>
                    <div class="step-label">Guest Details</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-label">Payment</div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-label">Confirmation</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Booking Form -->
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Guest Information</h4>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Contact Information -->
                        <h5 class="mb-3">Contact Information</h5>
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.passenger_name.id_for_label }}" class="form-label">
                                    Full Name *
                                </label>
                                <input type="text" class="form-control {% if form.passenger_name.errors %}is-invalid{% endif %}"
                                       id="{{ form.passenger_name.id_for_label }}" 
                                       name="{{ form.passenger_name.name }}"
                                       value="{{ form.passenger_name.value|default:user.get_full_name|default:'' }}"
                                       required>
                                {% if form.passenger_name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.passenger_name.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.passenger_email.id_for_label }}" class="form-label">
                                    Email Address *
                                </label>
                                <input type="email" class="form-control {% if form.passenger_email.errors %}is-invalid{% endif %}"
                                       id="{{ form.passenger_email.id_for_label }}"
                                       name="{{ form.passenger_email.name }}"
                                       value="{{ form.passenger_email.value|default:user.email|default:'' }}"
                                       required>
                                {% if form.passenger_email.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.passenger_email.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.passenger_phone.id_for_label }}" class="form-label">
                                    Phone Number *
                                </label>
                                <input type="tel" class="form-control {% if form.passenger_phone.errors %}is-invalid{% endif %}"
                                       id="{{ form.passenger_phone.id_for_label }}"
                                       name="{{ form.passenger_phone.name }}"
                                       value="{{ form.passenger_phone.value|default:'' }}"
                                       required>
                                {% if form.passenger_phone.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.passenger_phone.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.passenger_country.id_for_label }}" class="form-label">
                                    Country *
                                </label>
                                <select class="form-select {% if form.passenger_country.errors %}is-invalid{% endif %}"
                                        id="{{ form.passenger_country.id_for_label }}"
                                        name="{{ form.passenger_country.name }}" required>
                                    <option value="">Select Country</option>
                                    <option value="US" {% if form.passenger_country.value == "US" %}selected{% endif %}>United States</option>
                                    <option value="CA" {% if form.passenger_country.value == "CA" %}selected{% endif %}>Canada</option>
                                    <option value="UK" {% if form.passenger_country.value == "UK" %}selected{% endif %}>United Kingdom</option>
                                    <option value="IN" {% if form.passenger_country.value == "IN" %}selected{% endif %}>India</option>
                                    <!-- Add more countries as needed -->
                                </select>
                                {% if form.passenger_country.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.passenger_country.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Special Requests -->
                        <div class="mb-4">
                            <label for="{{ form.special_requests.id_for_label }}" class="form-label">
                                Special Requests (Optional)
                            </label>
                            <textarea class="form-control {% if form.special_requests.errors %}is-invalid{% endif %}"
                                      id="{{ form.special_requests.id_for_label }}"
                                      name="{{ form.special_requests.name }}"
                                      rows="3"
                                      placeholder="Any special requests or requirements...">{{ form.special_requests.value|default:'' }}</textarea>
                            {% if form.special_requests.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.special_requests.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Payment Method -->
                        <h5 class="mb-3">Payment Method</h5>
                        <div class="mb-4">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="payment_method" 
                                       id="credit_card" value="credit_card" checked>
                                <label class="form-check-label" for="credit_card">
                                    <i class="fas fa-credit-card me-2"></i> Credit/Debit Card
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="payment_method" 
                                       id="paypal" value="paypal">
                                <label class="form-check-label" for="paypal">
                                    <i class="fab fa-paypal me-2"></i> PayPal
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment_method" 
                                       id="wallet" value="wallet">
                                <label class="form-check-label" for="wallet">
                                    <i class="fas fa-wallet me-2"></i> Wallet Balance
                                </label>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="form-check mb-4">
                            <input class="form-check-input {% if form.terms_accepted.errors %}is-invalid{% endif %}"
                                   type="checkbox" id="terms_accepted" name="terms_accepted" required>
                            <label class="form-check-label" for="terms_accepted">
                                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms & Conditions</a> 
                                and <a href="#" data-bs-toggle="modal" data-bs-target="#cancellationModal">Cancellation Policy</a>
                            </label>
                            {% if form.terms_accepted.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.terms_accepted.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'hotels:hotel_detail' hotel.id %}" 
                               class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i> Back to Hotel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                Proceed to Payment <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column - Booking Summary -->
        <div class="col-md-4">
            <!-- Hotel Summary -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex align-items-start mb-3">
                        {% if hotel.thumbnail %}
                        <img src="{{ hotel.thumbnail.url }}" class="rounded me-3" 
                             alt="{{ hotel.name }}" style="width: 80px; height: 80px; object-fit: cover;">
                        {% endif %}
                        <div>
                            <h5 class="mb-1">{{ hotel.name }}</h5>
                            <p class="text-muted mb-0">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ hotel.city }}, {{ hotel.country }}
                            </p>
                        </div>
                    </div>

                    <!-- Booking Details -->
                    <div class="border-top pt-3">
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Check-in</div>
                            <div class="col-6 text-end">
                                <strong id="check_in_display">--</strong>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Check-out</div>
                            <div class="col-6 text-end">
                                <strong id="check_out_display">--</strong>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Nights</div>
                            <div class="col-6 text-end">
                                <strong id="nights_display">--</strong>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Guests</div>
                            <div class="col-6 text-end">
                                <strong id="guests_display">--</strong>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Rooms</div>
                            <div class="col-6 text-end">
                                <strong id="rooms_display">--</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Price Breakdown -->
                    <div class="border-top pt-3">
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Room Price</div>
                            <div class="col-6 text-end">
                                $<span id="room_price_display">--</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Taxes & Fees</div>
                            <div class="col-6 text-end">
                                $<span id="tax_display">--</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Service Charge</div>
                            <div class="col-6 text-end">
                                $<span id="service_display">--</span>
                            </div>
                        </div>
                        <div class="row mt-3 border-top pt-3">
                            <div class="col-6">
                                <h5 class="mb-0">Total</h5>
                            </div>
                            <div class="col-6 text-end">
                                <h4 class="text-primary mb-0">$<span id="total_display">--</span></h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Important Information -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="fas fa-info-circle text-primary me-2"></i> Important Information
                    </h6>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Free cancellation until 24 hours before check-in
                            </small>
                        </li>
                        <li class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                No prepayment required
                            </small>
                        </li>
                        <li class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Best price guarantee
                            </small>
                        </li>
                        <li>
                            <small class="text-muted">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                24/7 customer support
                            </small>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Terms Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terms & Conditions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>Booking Policy</h6>
                <p>All bookings are subject to availability and confirmation. Prices are subject to change without notice.</p>
                
                <h6 class="mt-3">Payment Policy</h6>
                <p>Full payment is required at the time of booking. We accept major credit cards, debit cards, and online payment methods.</p>
                
                <h6 class="mt-3">Cancellation Policy</h6>
                <p>Cancellations made more than 24 hours before check-in will receive a full refund. Cancellations made within 24 hours will incur a cancellation fee.</p>
                
                <h6 class="mt-3">Check-in/Check-out</h6>
                <p>Check-in time is 2:00 PM. Check-out time is 11:00 AM. Early check-in and late check-out are subject to availability and additional charges.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Cancellation Policy Modal -->
<div class="modal fade" id="cancellationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cancellation Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Free cancellation until 24 hours before check-in
                </div>
                
                <h6>Cancellation Charges</h6>
                <ul>
                    <li>More than 24 hours before check-in: Full refund</li>
                    <li>Within 24 hours of check-in: 50% of total amount</li>
                    <li>No-show: 100% of total amount</li>
                </ul>
                
                <h6 class="mt-3">Refund Process</h6>
                <p>Refunds will be processed within 7-10 business days to the original payment method. For wallet refunds, the amount will be credited instantly.</p>
                
                <h6 class="mt-3">Modification Policy</h6>
                <p>Modifications to dates or room type are subject to availability and rate differences. Please contact our customer support for modifications.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.progress-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
}

.progress-steps::before {
    content: '';
    position: absolute;
    top: 15px;
    left: 0;
    right: 0;
    height: 2px;
    background-color: #e9ecef;
    z-index: 1;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
}

.step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 8px;
}

.step.active .step-number {
    background-color: #0d6efd;
    color: white;
}

.step-label {
    font-size: 0.875rem;
    color: #6c757d;
}

.step.active .step-label {
    color: #0d6efd;
    font-weight: 500;
}
</style>

<script>
// Update booking summary from URL parameters
function updateBookingSummary() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Get values from URL or form
    const checkIn = urlParams.get('check_in') || document.getElementById('check_in')?.value;
    const checkOut = urlParams.get('check_out') || document.getElementById('check_out')?.value;
    const guests = urlParams.get('guests') || document.getElementById('guests')?.value || '2';
    const rooms = urlParams.get('rooms') || document.getElementById('rooms')?.value || '1';
    const roomType = urlParams.get('room_type');
    
    // Update displays
    if (checkIn) {
        document.getElementById('check_in_display').textContent = formatDate(checkIn);
    }
    if (checkOut) {
        document.getElementById('check_out_display').textContent = formatDate(checkOut);
    }
    document.getElementById('guests_display').textContent = guests;
    document.getElementById('rooms_display').textContent = rooms;
    
    // Calculate nights
    if (checkIn && checkOut) {
        const nights = calculateNights(checkIn, checkOut);
        document.getElementById('nights_display').textContent = nights;
        
        // Calculate prices (sample calculation)
        const roomPrice = 150; // This should come from selected room
        const totalRoomPrice = roomPrice * nights * parseInt(rooms);
        const tax = totalRoomPrice * 0.1;
        const service = totalRoomPrice * 0.05;
        const total = totalRoomPrice + tax + service;
        
        document.getElementById('room_price_display').textContent = totalRoomPrice.toFixed(2);
        document.getElementById('tax_display').textContent = tax.toFixed(2);
        document.getElementById('service_display').textContent = service.toFixed(2);
        document.getElementById('total_display').textContent = total.toFixed(2);
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

function calculateNights(checkIn, checkOut) {
    const start = new Date(checkIn);
    const end = new Date(checkOut);
    const diffTime = Math.abs(end - start);
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', updateBookingSummary);

// Update when form inputs change
['check_in', 'check_out', 'guests', 'rooms'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
        element.addEventListener('change', updateBookingSummary);
    }
});
</script>
{% endblock %}